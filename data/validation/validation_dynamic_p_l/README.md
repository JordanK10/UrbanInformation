# VI Model Validation Protocol

This folder contains the validation protocol for testing the Variational Inference (VI) model on dummy data before applying it to real geographic data.

## Overview

The validation protocol tests the SSM model's ability to recover agent beliefs from income trajectories in a controlled Kelly betting environment. This ensures the model works correctly before applying it to real CBSA/county/ZIP hierarchical analysis.

## Files

### Core Scripts

1. **`generate_vi_results.py`** - Fits VI models to all agents in the dummy data
2. **`plot_validation_results.py`** - Generates comprehensive validation plots
3. **`README.md`** - This documentation file

### Input Data

- **`../dummy_data_kelly_betting.pkl`** - Generated dummy data from `generate_dummy_data.py`
- **`../vi_fitted_results.pkl`** - VI fitting results (generated by `generate_vi_results.py`)

### Output

- **`validation_plots/`** - Directory containing all generated plots
  - `vi_loss_distribution.png` - Distribution of VI loss values
  - `parameter_comparison.png` - True vs fitted parameter comparison
  - `belief_evolution.png` - Agent belief evolution over time
  - `resource_trajectories.png` - Resource trajectories and growth rates

## Usage

### Step 1: Generate Dummy Data
```bash
cd ..
python generate_dummy_data.py
```

This creates `dummy_data_kelly_betting.pkl` with:
- 100 agents with beliefs (x) between 0.5 and 0.7
- l=2 (binary choice), p=0.7 environment
- 50 timesteps with Kelly betting dynamics
- Belief updating using learning equation: x = (p*t/(l*k) + xâ‚€)/(1 + t/(l*k)) where k=5

### Step 2: Fit VI Models to All Agents
```bash
cd validation
python generate_vi_results.py
```

This:
- Loads the dummy data
- Fits VI models to all 100 agents
- Saves results to `vi_fitted_results.pkl`
- Provides fitting statistics and success rates

### Step 3: Generate Validation Plots
```bash
python plot_validation_results.py
```

This creates comprehensive plots showing:
- **Loss Distribution**: VI convergence quality across agents
- **Parameter Comparison**: True vs fitted beliefs with error analysis
- **Belief Evolution**: How agent beliefs converge to true p over time
- **Resource Trajectories**: Growth dynamics and p_t series

## Validation Metrics

### Model Performance
- **Success Rate**: Percentage of agents with successful VI fits
- **Loss Distribution**: Mean, median, std of VI loss values
- **Parameter Recovery**: Correlation between true and fitted beliefs

### Data Quality
- **Belief Convergence**: How well beliefs converge to true p=0.7
- **Growth Rate Accuracy**: Theoretical vs actual growth rates
- **p_t Series**: Fraction of agents experiencing gains over time

## Expected Results

### Successful Validation
- **Success Rate**: >95% of agents should have successful VI fits
- **Parameter Recovery**: Correlation >0.8 between true and fitted beliefs
- **Belief Convergence**: Final beliefs should cluster around true p=0.7
- **Loss Values**: Mean loss <50, indicating good convergence

### What to Check
1. **No Bankrupt Agents**: All agents maintain positive resources
2. **Realistic Growth**: Growth rates match theoretical predictions
3. **Belief Learning**: Agents gradually learn the true environment probability
4. **VI Convergence**: Loss values are reasonable and consistent

## Troubleshooting

### Common Issues
1. **High Failure Rate**: Increase `vi_steps` in `generate_vi_results.py`
2. **Poor Parameter Recovery**: Check dummy data generation parameters
3. **Memory Issues**: Reduce number of agents or timesteps
4. **Import Errors**: Ensure `ssm_model.py` is in the parent directory

### Performance Tuning
- **VI Steps**: Increase for better convergence (default: 10,000)
- **Number of Agents**: 100 agents provides good statistical power
- **Timesteps**: 50 timesteps shows clear learning dynamics
- **Random Seed**: Fixed seed ensures reproducible results

## Next Steps

After successful validation:
1. **Apply to Real Data**: Use the validated model for hierarchical analysis
2. **Parameter Tuning**: Adjust VI parameters based on validation results
3. **Scale Up**: Test with larger datasets and more complex environments
4. **Model Comparison**: Compare VI vs MCMC performance

## Theory Background

The validation uses Kelly betting theory where:
- **Environment**: Binary choice (l=2) with probability p=0.7
- **Agent Strategy**: Allocate resources based on beliefs x
- **Rewards**: Fair odds (l=2) for correct allocations
- **Learning**: Beliefs update using Bayesian learning equation
- **Objective**: Maximize long-term resource growth rate

This provides a controlled environment to test the SSM model's ability to recover agent beliefs from observed income trajectories. 